<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Claude_10_Brain Atlas for X-ALD MRI Severity Score</title>
    <meta name="description" content="Explore our interactive Brain Atlas tailored for MRI severity scoring in X-linked adrenoleukodystrophy (X-ALD), developed by leading researchers.">
    <meta name="keywords" content="X-ALD, Brain Atlas, MRI, Severity Scoring, Neurology, Adrenoleukodystrophy">
    <link rel="stylesheet" type="text/css" href="papaya/papaya.css">
    <script type="text/javascript" src="papaya/papaya.js"></script>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            font-family: 'Arial', sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        .sidebar {
            height: 100%;
            width: 220px;
            position: fixed;
            z-index: 1;
            top: 0;
            left: 0;
            background-color: #f9f9f9;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding-top: 20px;
            overflow-x: hidden;
        }
        .sidebar a, .sidebar a:visited {
            padding: 10px 15px;
            text-decoration: none;
            font-size: 16px;
            color: #666;
            display: block;
            transition: color 0.3s;
        }
        .sidebar a:hover, .sidebar a:focus {
            color: #fff;
            background-color: #4CAF50;
        }
        .sidebar img {
            width: 100%;
            height: auto;
            margin: 10px 0;
            padding: 5px;
            display: block;
        }
        .main {
            margin-left: 220px;
            padding: 20px;
            background-color: #f5f5f5;
            height: calc(100vh - 40px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        h1, h2, h3 {
            color: #333;
        }
        p {
            line-height: 1.6;
            margin-bottom: 10px;
        }
        #viewerContainer {
            display: flex;
            justify-content: space-between;
            height: calc(100vh - 140px);  /* Adjust this value as needed */
            width: 100%;
        }
        #papayaContainer {
            width: 70%;
            height: 100%;
            overflow: hidden;
        }
        .papaya {
            width: 100% !important;  /* Force Papaya to use full width of container */
            height: 100% !important; /* Force Papaya to use full height of container */
        }
        #regionControls {
            width: 28%;
            height: 100%;
            overflow-y: auto;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-left: 2%;
        }
        .region-toggle {
            margin-bottom: 10px;
        }
        .region-toggle label {
            margin-left: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="sidebar">
    <a href="#" onclick="showHome()"><strong>Home</strong></a>
    <a href="#" onclick="showViewer()"><strong>Interactive Viewer</strong></a>
    <a href="#" onclick="showLoesScore()"><strong>Loes Score</strong></a>
    <a href="#" onclick="showDownload()"><strong>Download</strong></a>
    <a></a>
    <a></a>
    <a href="https://idi.gencat.cat/" target="_blank">
        <img src="images/IDI.gif" alt="IDI Logo">
    </a>
    <a href="https://bellvitgehospital.cat/ca" target="_blank">
        <img src="images/Bellvitge.png" alt="Bellvitge Hospital Universitari Logo">
    </a>
    <a href="https://idibell.cat/es/" target="_blank">
        <img src="images/IDIBELL.png" alt="IDIBELL Logo">
    </a>
</div>

<div class="main">
    <div id="content" class="content">
        <h2>Welcome to the Brain Atlas for X-ALD</h2>
        <p>This educational website provides an interactive visual way to explore the atlas for X-linked adrenoleukodystrophy (X-ALD) developed by Naval-Baudin et al. (2024), which is based on the descriptions of the X-ALD Disease Severity Scoring method described by <a href="https://www.ajnr.org/content/15/9/1761" target="_blank">Loes et al. (1994)</a>.</p>
        <p>The atlas and this visual tool have been developed with contributions from researchers at the Bellvitge University Hospital, Institut de Diagnostic per la Imatge, and IDIBELL, aiming to make the evaluation of disease severity as accessible as possible.</p>
    </div>
</div>

<script type="text/javascript">
    var params = [];
    var papayaContainers = [];
    var regionLabels = {};
    var currentViewer = null;
    var atlasVolume = null;
    var originalAtlasData = null;

	function loadRegionLabels() {
		return fetch('data/region_labels.txt')
			.then(response => response.text())
			.then(text => {
				text.split('\n').forEach(line => {
					if (line.trim() !== '') {
						const [fullName, index] = line.split(': ');
						regionLabels[index] = { shortName: fullName, fullName: fullName };
					}
				});
				console.log('Loaded region labels:', regionLabels);  // Debugging log
			})
			.catch(error => console.error('Error loading region labels:', error));
	}


    // Load region labels when the page loads
    window.onload = function() {
        loadRegionLabels().then(() => {
            if (window.location.hash === '#viewer') {
                showViewer();
            } else {
                showHome();
            }
        });
    };

    function showHome() {
        const container = document.getElementById('content');
        container.innerHTML = `
            <h2>Welcome to the Brain Atlas for X-ALD</h2>
            <p>This educational website provides an interactive visual way to explore the atlas for X-linked adrenoleukodystrophy (X-ALD) developed by Naval-Baudin et al. (2024), which is based on the descriptions of the X-ALD Disease Severity Scoring method described by <a href="https://www.ajnr.org/content/15/9/1761" target="_blank">Loes et al. (1994)</a>.</p>
            <p>The atlas and this visual tool have been developed with contributions from researchers at the Bellvitge University Hospital, Institut de Diagnostic per la Imatge, and IDIBELL, aiming to make the evaluation of disease severity as accessible as possible.</p>
        `;
    }

    function showViewer() {
        const container = document.getElementById('content');
        container.innerHTML = `
            <h2>Interactive Brain Atlas Viewer</h2>
            <div id="viewerContainer">
                <div id="papayaContainer"></div>
                <div id="regionControls"></div>
            </div>
        `;

        try {
            params = [];
            params['images'] = ['data/template.nii.gz', 'data/atlas.nii.gz'];
            params['atlas.nii.gz'] = {
                lut: "Spectrum",
                alpha: 0.5,
                min: 0,
                max: 45
            };

            // Initialize Papaya
            papaya.Container.addViewer("papayaContainer", params, function(err, viewer) {
                if (err) {
                    console.error("Error loading viewer:", err);
                    container.innerHTML += `<p>Error loading viewer: ${err.message}</p>`;
                } else {
                    console.log("Viewer loaded successfully");
                    currentViewer = viewer;
                    
                    // Wait for images to load
                    const checkImages = setInterval(() => {
                        if (currentViewer.screenVolumes && currentViewer.screenVolumes.length > 1) {
                            clearInterval(checkImages);
                            atlasVolume = currentViewer.screenVolumes[1].volume;
                            
                            if (atlasVolume && atlasVolume.imageData) {
                                originalAtlasData = new Uint8Array(atlasVolume.imageData.buffer);
                                createRegionToggles(currentViewer);
                                console.log("Region toggles created");  // Debugging log
                            } else {
                                console.error("Atlas volume or imageData is undefined");
                                container.innerHTML += `<p>Error: Atlas data not found</p>`;
                            }
                        }
                    }, 100);
                }
            });

        } catch (error) {
            console.error("Error initializing Papaya viewer:", error);
            container.innerHTML += `<p>Error loading viewer: ${error.message}</p>`;
        }
    }

	function createRegionToggles(viewer) {
		const controlsContainer = document.getElementById('regionControls');
		controlsContainer.innerHTML = '<h3>Region Controls</h3>';  // Add a header

		Object.entries(regionLabels).forEach(([index, { fullName }]) => {
			const toggle = document.createElement('div');
			toggle.className = 'region-toggle';
			toggle.innerHTML = `
				<input type="checkbox" id="region${index}" checked>
				<label for="region${index}">${fullName}</label>
			`;
			toggle.querySelector('input').addEventListener('change', function() {
				toggleRegion(viewer, parseInt(index), this.checked);
			});
			controlsContainer.appendChild(toggle);
		});

		console.log(`Created ${Object.keys(regionLabels).length} region toggles`);  // Debugging log
	}


    function toggleRegion(viewer, regionIndex, isVisible) {
        if (!viewer) {
            console.error("Viewer is undefined");
            return;
        }
        if (!atlasVolume) {
            console.error("Atlas volume is undefined");
            return;
        }
        if (!atlasVolume.imageData) {
            console.error("Atlas image data is undefined");
            return;
        }
        if (!originalAtlasData) {
            console.error("Original atlas data is undefined");
            return;
        }

        const imageData = new Uint8Array(atlasVolume.imageData.buffer);
        for (let i = 0; i < imageData.length; i++) {
            if (originalAtlasData[i] === regionIndex) {
                imageData[i] = isVisible ? regionIndex : 0;
            }
        }
        viewer.drawViewer(true, false);
    }

    function showLoesScore() {
        const container = document.getElementById('content');
        container.innerHTML = `
            <h2>MRI Severity Scoring System by Loes et al. (1994)</h2>
            <table border="1">
                <thead>
                    <tr>
                        <th>Anatomical Region</th>
                        <th>Feature</th>
                        <th>Points Assigned</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Parietal-Occipital White Matter -->
                    <tr>
                        <td rowspan="4">PARIETAL-OCCIPITAL WHITE MATTER</td>
                        <td>Periventricular</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>Central</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>Subcortical</td>
                        <td>1</td>
                    </tr>
                    <tr>
                        <td>Atrophy</td>
                        <td>1</td>
                    </tr>
                    <!-- Add more rows for other anatomical regions -->
                </tbody>
            </table>
        `;
    }

    function showDownload() {
        const container = document.getElementById('content');
        container.innerHTML = `
            <h3>Download the X-ALD Atlas in FSL MNI152 space</h3>
            <p><a href="https://zenodo.org/records/11047634" target="_blank">Download the atlas files in MNI152 space in our Zenodo repository.</a> [Link will be activated upon definitive peer-reviewed publication]</p>
            <h3>Licensing Information</h3>
            <p>All content available on this website, including images and data from the Brain Atlas for X-ALD, is licensed for free use, including commercial purposes, provided that appropriate credit is given to the original source. Users are encouraged to share, copy, distribute, and transmit the work or adapt it to suit their professional needs, as long as proper acknowledgment is provided to 'Naval-Baudin et al. (2024)' [yet unpublished] and linked publications.</p>
            <h3>Contact</h3>
            <p>For queries or suggestions, please contact <strong><a href="mailto:pablo.naval.idi@gencat.cat">pablo.naval.idi@gencat.cat</a></strong>.</p>
        `;
    }
</script>

</body>
</html>